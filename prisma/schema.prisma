// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-1.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DATABASE_DIRECT_URL")
}

model User {
  id                                String            @id @default(uuid())
  name                              String
  email                             String
  phone                             String
  password                          String
  avatar                            String?
  customer_id_from_payment_provider String?
  created_at                        DateTime          @map("created_at")
  updated_at                        DateTime?         @map("updated_at")
  estimateRequests                  EstimateRequest[]
  role                              String            @default("customer")
  active                            Boolean           @default(false)

  companies Company[]
  UserToken UserToken[]

  user_plans UserPlan[]
  plan_usage PlanUsage[]
  reviews    CompanyReview[]
  job        Job[]
  customer   Customer[]

  @@map("users")
}

model Customer {
  id         String    @id @default(uuid())
  name       String
  email      String
  phone      String
  document   String
  user_id    String
  created_at DateTime  @default(now()) @map("created_at")
  updated_at DateTime? @map("updated_at")

  user            User             @relation(fields: [user_id], references: [id])
  scheduled_visit ScheduledVisit[]

  @@map("customers")
}

model ScheduledVisit {
  id                  String      @id @default(uuid())
  customer_id         String
  company_id          String
  estimate_request_id String
  scheduled_at        DateTime
  status              VisitStatus @default(PENDING)
  suggested_at        DateTime?
  notes               String?
  created_at          DateTime    @default(now())
  updated_at          DateTime    @updatedAt

  customer         Customer        @relation(fields: [customer_id], references: [id])
  estimate_request EstimateRequest @relation(fields: [estimate_request_id], references: [id])
  company          Company         @relation(fields: [company_id], references: [id])

  @@map("scheduled_visits")
}

enum VisitStatus {
  PENDING // Aguardando confirmação do prestador
  CONFIRMED // Prestador aceitou
  SUGGESTED // Prestador sugeriu novo horário
  RESCHEDULED // Cliente aceitou sugestão
  CANCELED
  COMPLETED
}

model Plan {
  id             String    @id
  name           String
  description    String?
  resources      Json // Ex: { proposalsPerMonth: 5 }
  price_month    Float     @default(0)
  price_id_month String?
  price_year     Float     @default(0)
  price_id_year  String?
  actived        Boolean   @default(true)
  created_at     DateTime  @default(now()) @map("created_at")
  updated_at     DateTime? @map("updated_at")

  user_plans UserPlan[]

  @@map("plans")
}

model UserPlan {
  id         String    @id @default(uuid())
  user_id    String
  plan_id    String
  plan_type  String    @default("monthly") // monthly, yearly
  price      Float     @default(0)
  status     String    @default("active") // active, cancelled, expired, etc
  start_date DateTime  @default(now())
  end_date   DateTime?

  user       User        @relation(fields: [user_id], references: [id])
  plan       Plan        @relation(fields: [plan_id], references: [id])
  plan_usage PlanUsage[]
  created_at DateTime    @default(now())

  @@map("user_plans")
}

model PlanUsage {
  id           String    @id @default(uuid())
  user_plan_id String
  resource     String
  count        Int       @default(0)
  period       DateTime?

  user_plan  UserPlan @relation(fields: [user_plan_id], references: [id])
  User       User     @relation(fields: [user_id], references: [id])
  user_id    String
  created_at DateTime @default(now())

  @@unique([user_plan_id, resource, period])
  @@map("plan_usage")
}

model UserToken {
  id         String   @id @default(uuid())
  type       String
  token      String   @unique
  user_id    String
  user       User     @relation(fields: [user_id], references: [id])
  used       Boolean
  expires_at DateTime
  created_at DateTime @default(now())

  @@map("user_tokens")
}

model Notification {
  id           String    @id @default(uuid())
  title        String
  type         String
  message      String
  read         Boolean
  recipient_id String
  created_at   DateTime  @map("created_at")
  updated_at   DateTime? @map("updated_at")

  @@map("notifications")
}

model EstimateRequest {
  id                   String                                @id @default(uuid())
  footage              Int
  name                 String
  phone                String
  email                String
  description          String
  location             Unsupported("geography(Point,4326)")?
  user_id              String                                @map("user_id")
  address_street       String
  address_number       String
  address_postal_code  String
  address_neighborhood String
  address_state        String
  address_city         String
  latitude             Float
  longitude            Float
  category             String

  created_at  DateTime  @map("created_at")
  updated_at  DateTime? @map("updated_at")
  finished_at DateTime? @map("finished_at")

  user                      User?                     @relation(fields: [user_id], references: [id])
  files                     EstimateRequestFile[]
  proposals                 Proposal[]
  messages                  Message[]
  job                       Job[]
  scheduled_visit           ScheduledVisit[]
  progress_estimate_request ProgressEstimateRequest[]

  @@map("estimate_request")
}

model ProgressEstimateRequest {
  id                  String          @id @default(uuid())
  estimate_request_id String
  type ProgressEstimateRequestType
  title String
  description String
  estimate_request    EstimateRequest @relation(fields: [estimate_request_id], references: [id])
  created_at   DateTime  @map("created_at")
  @@map("progress_estimate_request")
}
enum ProgressEstimateRequestType {
  CREATED
  PROPOSALS_WAITING
  PROPOSALS_RECEIVED
  PROPOSALS_ACCEPTED
  VISIT_REQUESTED
  VISIT_CONFIRMED
  VISIT_SUGGESTED
  VISIT_COMPLETED
  PAYMENT_REQUESTED
  PAYMENT_COMPLETED
  WAITING
  FINISHED
}


model Proposal {
  id          String    @id @default(uuid())
  name        String
  amount      Float
  description String
  created_at  DateTime
  updated_at  DateTime?
  approved_at DateTime?
  reject_at   DateTime?
  expire_at   DateTime

  estimate_id         String
  estimate_request_id String
  company_id          String
  is_required_visit Boolean @default(false)

  estimate_request EstimateRequest @relation(fields: [estimate_request_id], references: [id])
  estimate         Estimate        @relation(fields: [estimate_id], references: [id])
  company          Company         @relation(fields: [company_id], references: [id])
  job              Job?

  @@map("proposals")
}

model Estimate {
  id          String    @id @default(uuid())
  company     Json
  company_id  String
  customer    Json
  description String
  total       Float
  expire_at   DateTime
  created_at  DateTime
  updated_at  DateTime?

  estimate_items EstimateItems[]
  proposals      Proposal[]
  job            Job[]

  @@map("estimates")
}

model EstimateItems {
  id          String @id @default(uuid())
  type        String
  name        String
  description String
  unit        String
  price       Float
  quantity    Int
  total       Float

  estimate_id String
  created_at  DateTime
  updated_at  DateTime?
  estimate    Estimate  @relation(fields: [estimate_id], references: [id])

  @@map("estimate_items")
}

model Message {
  id                  String     @id @default(uuid())
  content             String
  sender              SenderType // 'CLIENT' ou 'COMPANY'
  type                String
  estimate_request_id String
  company_id          String
  user_id             String
  company_name        String
  user_name           String
  read                Boolean?   @default(false)
  created_at          DateTime   @default(now())
  updated_at          DateTime   @default(now())

  estimate_request EstimateRequest @relation(fields: [estimate_request_id], references: [id])

  @@map("messages")
}

enum SenderType {
  CLIENT
  COMPANY
}

model EstimateRequestFile {
  id                  String    @id @default(uuid())
  url                 String
  estimate_request_id String    @map("estimate_request_id")
  created_at          DateTime  @map("created_at")
  updated_at          DateTime? @map("updated_at")

  estimateRequest EstimateRequest @relation(fields: [estimate_request_id], references: [id])

  @@map("estimate_request_files")
}

model File {
  id         String    @id @default(uuid())
  name       String
  type       String
  created_at DateTime  @map("created_at")
  updated_at DateTime? @map("updated_at")

  @@map("files")
}

model Post {
  id         String    @id @default(uuid())
  title      String
  body       String    @db.Text
  user_id    String
  company_id String
  status     String
  created_at DateTime
  updated_at DateTime?

  post_files PostFile[]
  tags       Tag[]

  @@map("posts")
}

model TagPost {
  id      String @id @default(uuid())
  tag_id  String
  post_id String
  tag     Tag    @relation(fields: [tag_id], references: [id])

  @@map("tag_posts")
}

model Tag {
  id         String    @id @default(uuid())
  name       String
  post_id    String    @map("post_id")
  created_at DateTime  @map("created_at")
  updated_at DateTime? @map("updated_at")

  post Post      @relation(fields: [post_id], references: [id])
  tags TagPost[]

  @@map("tags")
}

model PostFile {
  id         String  @id @default(uuid())
  post_id    String
  company_id String
  before_url String?
  url        String

  post Post @relation(fields: [post_id], references: [id])

  created_at DateTime  @map("created_at")
  updated_at DateTime? @map("updated_at")

  @@map("post_files")
}

model CompanyAddress {
  id         String                                @id @default(uuid())
  name       String
  address    String
  city       String
  state      String
  country    String
  zip        String
  latitude   Float
  longitude  Float
  created_at DateTime                              @map("created_at")
  updated_at DateTime?                             @map("updated_at")
  location   Unsupported("geography(Point,4326)")?
  company    Company?

  @@map("company_address")
}

model Company {
  id         String  @id @default(uuid())
  name       String
  avatar     String?
  ratting    Float   @default(0)
  about      String?
  phone      String?
  email      String?
  website    String?
  owner_id   String  @map("owner_id")
  address_id String  @unique

  owner     User             @relation(fields: [owner_id], references: [id])
  proposals Proposal[]
  jobs      Job[]
  services  CompanyService[]

  address CompanyAddress @relation(fields: [address_id], references: [id])

  created_at      DateTime         @map("created_at")
  updated_at      DateTime?        @map("updated_at")
  reviews         CompanyReview[]
  scheduled_visit ScheduledVisit[]

  @@map("company")
}

model CompanyReview {
  id         String   @id @default(uuid())
  rating     Int
  title      String
  comment    String?
  company_id String
  user_id    String
  job_id     String
  created_at DateTime @default(now())

  company Company             @relation(fields: [company_id], references: [id])
  job     Job                 @relation(fields: [job_id], references: [id])
  user    User                @relation(fields: [user_id], references: [id])
  files   CompanyReviewFile[]

  @@unique([company_id, user_id])
  @@map("company_reviews")
}

model CompanyReviewFile {
  id                String   @id @default(uuid())
  company_review_id String
  url               String
  created_at        DateTime @default(now())

  company_review CompanyReview @relation(fields: [company_review_id], references: [id])

  @@map("company_reviews_files")
}

model Job {
  id                  String @id @default(uuid())
  company_id          String @map("company_id")
  proposal_id         String @unique @map("proposal_id")
  user_id             String
  estimate_request_id String @map("estimate_request_id")
  estimate_id         String @map("estimate_id")
  status              String @default("BACKLOG")

  company          Company         @relation(fields: [company_id], references: [id])
  user             User            @relation(fields: [user_id], references: [id])
  proposal         Proposal        @relation(fields: [proposal_id], references: [id])
  estimate_request EstimateRequest @relation(fields: [estimate_request_id], references: [id])
  estimate         Estimate        @relation(fields: [estimate_id], references: [id])

  created_at     DateTime        @map("created_at")
  updated_at     DateTime?       @map("updated_at")
  company_review CompanyReview[]

  @@map("jobs")
}

model CompanyService {
  id            String    @id @default(uuid())
  name          String
  category_name String
  company_id    String
  category_id   String
  created_at    DateTime
  updated_at    DateTime?

  company  Company  @relation(fields: [company_id], references: [id])
  category Category @relation(fields: [category_id], references: [id])

  @@map("company_services")
}

model Category {
  id         String           @id @default(uuid())
  name       String
  created_at DateTime         @map("created_at")
  updated_at DateTime?        @map("updated_at")
  companies  CompanyService[]

  @@map("categories")
}
